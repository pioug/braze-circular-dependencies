import C from"../common/base-provider.js";import e from"../managers/braze-instance.js";import Feed from"./feed.js";import{newCardFromFeedJson as tt,newCardFromSerializedValue as _}from"../Card/util/card-factory.js";import{rehydrateDateAfterJsonization as w}from"../util/date-utils.js";import{STORAGE_KEYS as o}from"../managers/storage-manager.js";import u from"../managers/subscription-manager.js";export default class ee extends C{constructor(t,s){super(),this.h=t,this.Vs=s,this.vt=new u,e.yt(this.vt),this.zt()}zt(){const t=this.h.I(o.q.Ws)||[],s=[];for(let i=0;i<t.length;i++){const e=_(t[i]);null!=e&&s.push(e)}this.Yt=s,this.Xs=w(this.h.I(o.q.Ys))}Zs(t){const s=[];let i=null;const e=this.h.I(o.q.P)||{},r={};for(let h=0;h<t.length;h++){i=t[h];const o=tt(i);null!=o&&(e[o.id]&&(o.viewed=!0,r[o.id]=!0),s.push(o))}this.h.B(o.q.P,r),this.Yt=s,this._s(),this.Xs=new Date,this.h.B(o.q.Ys,this.Xs)}_s(){const t=[];for(let s=0;s<this.Yt.length;s++)t.push(this.Yt[s].ss());this.h.B(o.q.Ws,t)}ys(t){null!=t&&t.feed&&(this.zt(),this.Zs(t.feed),this.vt.St(new Feed(this.Yt.slice(),this.Xs)))}si(){this.zt();const t=[],s=new Date;for(let i=0;i<this.Yt.length;i++)(null==this.Yt[i].expiresAt||this.Yt[i].expiresAt>=s)&&t.push(this.Yt[i]);return new Feed(t,this.Xs)}Fs(){this.Vs.requestFeedRefresh()}Hs(t){return this.vt.ut(t)}clearData(t){null==t&&(t=!1),this.Yt=[],this.Xs=null,t&&(this.h.Is(o.q.Ws),this.h.Is(o.q.Ys)),this.vt.St(new Feed(this.Yt.slice(),this.Xs))}}