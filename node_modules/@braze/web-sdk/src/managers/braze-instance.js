import St from"./auth-manager.js";import C from"../common/base-provider.js";import et from"../util/browser-detector.js";import It from"./device-manager.js";import DeviceProperties from"../Core/device-properties.js";import{isArray as p,keys as Y,validateValueIsFromEnum as K,values as At}from"../util/code-utils.js";import{logDeprecationWarning as y}from"../util/deprecation-utils.js";import wt from"./network-manager.js";import Tt from"../request-controller.js";import Ot from"./server-config-manager.js";import Ct from"./session-manager.js";import r from"../../shared-lib/braze-shared-lib.js";import A,{STORAGE_KEYS as o}from"./storage-manager.js";import Lt from"./storage-manager-factory.js";import u from"./subscription-manager.js";import{TriggersProviderFactory as V}from"../triggers/triggers-provider-factory.js";import bt from"../User/user-manager.js";import{User}from"../User/index.js";import{parseQueryStringKeyValues as st}from"../util/url-utils.js";import{WindowUtils as G}from"../util/window-utils.js";const D={$n:"allowCrawlerActivity",ho:"baseUrl",po:"noCookies",Eo:"devicePropertyAllowlist",ra:"disablePushTokenMaintenance",_o:"enableLogging",Io:"enableSdkAuthentication",ta:"manageServiceWorkerExternally",Ao:"minimumIntervalBetweenTriggerActionsInSeconds",So:"sessionTimeoutInSeconds",No:"appVersion",ea:"serviceWorkerLocation",na:"safariWebsitePushId",Mn:"localization",ao:"contentSecurityNonce",wo:"enableHtmlInAppMessages",To:"allowUserSuppliedJavascript",no:"inAppMessageZIndex",lo:"openInAppMessagesInNewTab",tn:"openCardsInNewTab",en:"openNewsFeedCardsInNewTab",Ci:"requireExplicitInAppMessageDismissal",Oo:"doNotLoadFontAwesome",vo:"sdkFlavor"};class Pt{constructor(){this.Co=!1,this.Lo=!1,this.Po=new u,this.Ro=new u,this.Mo={},this.yo=[],this.Do=[],this.De=[],this.jo="4.1.0"}zo(t){this.Po.ut(t)}Hi(t){this.Ro.ut(t)}initialize(t,i){if(this.Uo())return r.D.info("Braze has already been initialized with an API key."),!0;this.Mo=i||{};let s=this.nn(D._o);const e=st(G.Nn());if(e&&"true"===e.brazeLogging&&(s=!0),r.D.init(s),r.D.info(`Initialization Options: ${JSON.stringify(this.Mo,null,2)}`),null==t||""===t||"string"!=typeof t)return r.D.error("Braze requires a valid API key to be initialized."),!1;this.Vi=t;let n=this.nn(D.ho);if(null==n||""===n||"string"!=typeof n)return r.D.error("Braze requires a valid baseUrl to be initialized."),!1;if(n=n.replace(/(\.[a-z]+)[^\.]*$/i,"$1/api/v3"),0!==n.indexOf("http")&&(n="https://"+n),this.Bo=n,et.Wo&&!this.nn(D.$n))return r.D.info("Ignoring activity from crawler bot "+navigator.userAgent),this.Lo=!0,!1;const a=this.nn(Pt.po)||!1;if(this.h=Lt.Vo(t,a),new A.ne(null,!0).lr(o.ae))return r.D.info("Ignoring all activity due to previous opt out"),this.Lo=!0,!1;for(const t of Y(this.Mo))-1===At(r.Go).indexOf(t)&&r.D.warn(`Ignoring unknown initialization option '${t}'.`);const h=["mparticle","wordpress","tealium"];if(null!=this.nn(D.vo)){const t=this.nn(D.vo);-1!==h.indexOf(t)?this.Ko=t:r.D.error("Invalid sdk flavor passed: "+t)}let l=this.nn(r.Go.Eo);if(null!=l)if(p(l)){const t=[];for(let i=0;i<l.length;i++)K(DeviceProperties,l[i],"devicePropertyAllowlist contained an invalid value.","DeviceProperties")&&t.push(l[i]);l=t}else r.D.error("devicePropertyAllowlist must be an array. Defaulting to all properties."),l=null;this.qi=new It(this.h,l),this.wt=new Ot(this.h),this.v=new bt(this.wt,this.h),this.j=new Ct(this.h,this.v,this.wt,this.nn(D.So));const c=new u;return this.Fo=new St(this.h,this.nn(D.Io),c),this.yt(c),this.jt=new wt(this.qi,this.h,this.Fo,this.v,this.j,this.wt,this.Vi,this.Bo,this.jo,this.Ko,this.nn(D.No)),this.Vs=new Tt(this.Vi,this.Bo,this.j,this.qi,this.v,this.wt,this.h,(t=>{if(this.Uo())for(const i of this.re())i.ys(t)}),this.Fo,this.jt),this.Vs.initialize(),r.D.info(`Initialized for the Braze backend at "${this.nn(D.ho)}" with API key "${this.Vi}".`),null!=this.nn(D.wo)&&y("enableHtmlInAppMessages","initialization option","allowUserSuppliedJavascript"),V.init(),this.Po.St(this.Mo),this.Co=!0,!0}destroy(t){if(r.D.destroy(),this.Uo()){this.Ro.St(),this.Ro.removeAllSubscriptions();for(const t of this.yo)t.destroy();this.yo=[];for(const t of this.Do)t.clearData(!1);this.Do=[],this.removeAllSubscriptions(),this.De=[],this.Vs.destroy(),this.Vs=null,this.Fo=null,this.qi=null,this.jt=null,this.wt=null,this.j=null,this.v=null,this.Mo={},this.Ko=void 0,this.Co=!1,this.Lo=!1,t&&(this.h=null)}}rr(){if(this.Ho())return!1;if(!this.Uo())throw new Error("Braze must be initialized before calling methods.");return!0}aa(){return this.Vi}ti(){return this.Fo}Ps(){return this.Bo}ce(){return this.qi}nr(){return this.jt}nn(t){return this.Mo[t]}re(){return this.Do}mr(){return this.Vs}ir(){return this.wt}g(){return this.j}l(){return this.h}gr(){if(this.v&&this.Vs)return new User(this.v,this.Vs)}p(){return this.v}tr(){return!0===this.nn(D.To)||!0===this.nn(D.wo)}u(t){let i=!1;for(const s of this.yo)s===t&&(i=!0);i||this.yo.push(t)}ar(t){let i=!1;for(const s of this.Do)s.constructor===t.constructor&&(i=!0);t instanceof C&&!i&&this.Do.push(t)}yt(t){t instanceof u&&this.De.push(t)}removeAllSubscriptions(){if(this.rr())for(const t of this.De)t.removeAllSubscriptions()}removeSubscription(t){if(this.rr())for(const i of this.De)i.removeSubscription(t)}le(t){this.Lo=t}Uo(){return this.Co}Ho(){return this.Lo}Ds(){return this.jo}}const e=new Pt;export{e as default,Pt as BrazeSdkInstance,D as OPTIONS};