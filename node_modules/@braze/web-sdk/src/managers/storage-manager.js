import et from"../util/browser-detector.js";import ue from"../models/braze-event.js";import _t from"../models/identifier.js";import{isArray as p,keys as Y,validateValueIsFromEnum as K,values as At}from"../util/code-utils.js";import r from"../../shared-lib/braze-shared-lib.js";import{User}from"../User/index.js";export const STORAGE_KEYS={Cr:{Ur:"ab.storage.userId",Jo:"ab.storage.deviceId",Dh:"ab.storage.sessionId"},q:{Sa:"ab.test",Ta:"ab.storage.events",Ia:"ab.storage.attributes",Ka:"ab.storage.attributes.anonymous_user",Yo:"ab.storage.device",oa:"ab.storage.sdk_metadata",ha:"ab.storage.session_id_for_cached_metadata",xn:"ab.storage.pushToken",Ws:"ab.storage.newsFeed",Ys:"ab.storage.lastNewsFeedRefresh",P:"ab.storage.cardImpressions",nh:"ab.storage.serverConfig",Ya:"ab.storage.triggers",Ga:"ab.storage.triggers.ts",Ch:"ab.storage.messagingSessionStart",Xt:"ab.storage.cc",ws:"ab.storage.ccLastFullSync",Ss:"ab.storage.ccLastCardUpdated",$:"ab.storage.ccClicks",O:"ab.storage.ccImpressions",K:"ab.storage.ccDismissals",Na:"ab.storage.lastDisplayedTriggerTimesById",va:"ab.storage.lastDisplayedTriggerTime",Ma:"ab.storage.triggerFireInstancesById",Ln:"ab.storage.signature",Ts:"ab.storage.sdkVersion"},ae:"ab.optOut"};export default class A{constructor(t,e){this.Ca=t,this.ya=e}Lr(t,e){let s=e;null!=e&&e instanceof _t&&(s=e.ss()),this.Ca.store(t,s)}Ua(t){const e=this._r(t);null!=e&&(e._h=(new Date).valueOf(),this.Lr(t,e))}_r(t){return _t.Rn(this.Ca.lr(t))}qh(t){this.Ca.remove(t)}bo(t){if(null==t||0===t.length)return!1;p(t)||(t=[t]);let e=this.ya.lr(STORAGE_KEYS.q.Ta);null!=e&&p(e)||(e=[]);for(let s=0;s<t.length;s++)e.push(t[s].ss());return this.ya.store(STORAGE_KEYS.q.Ta,e)}Hh(t){return null!=t&&this.bo([t])}Ba(){let t=this.ya.lr(STORAGE_KEYS.q.Ta);this.ya.remove(STORAGE_KEYS.q.Ta),null==t&&(t=[]);const e=[];let s=!1,o=null;if(p(t))for(let s=0;s<t.length;s++)ue.Fa(t[s])?e.push(ue.Rn(t[s])):o=s;else s=!0;if(s||null!=o){let n="Stored events could not be deserialized as Events";s&&(n+=", was "+Object.prototype.toString.call(t)+" not an array"),null!=o&&(n+=", value at index "+o+" does not look like an event"),n+=", serialized values were of type "+typeof t+": "+JSON.stringify(t),e.push(new ue(null,r.A.fa,(new Date).valueOf(),null,{e:n}))}return e}B(t,e){return!!K(STORAGE_KEYS.q,t,"StorageManager cannot store object.","STORAGE_KEYS.OBJECTS")&&this.ya.store(t,e)}I(t){return!!K(STORAGE_KEYS.q,t,"StorageManager cannot retrieve object.","STORAGE_KEYS.OBJECTS")&&this.ya.lr(t)}Is(t){return!!K(STORAGE_KEYS.q,t,"StorageManager cannot remove object.","STORAGE_KEYS.OBJECTS")&&(this.ya.remove(t),!0)}clearData(){const t=Y(STORAGE_KEYS.Cr),e=Y(STORAGE_KEYS.q);for(let e=0;e<t.length;e++){const s=t[e];this.Ca.remove(STORAGE_KEYS.Cr[s])}for(let t=0;t<e.length;t++){const s=e[t];this.ya.remove(STORAGE_KEYS.q[s])}}La(t){return t||STORAGE_KEYS.q.Ka}Aa(t){let e=this.ya.lr(STORAGE_KEYS.q.Ia);null==e&&(e={});const s=this.La(t[User.En]);for(let r in t)r===User.En||null!=e[s]&&null!=e[s][r]||this.Kr(t[User.En],r,t[r])}Kr(t,e,s){let r=this.ya.lr(STORAGE_KEYS.q.Ia);null==r&&(r={});const o=this.La(t);let n=r[o];if(null==n&&(n={},null!=t&&(n[User.En]=t)),e===User.Jr){null==n[e]&&(n[e]={});for(let t in s)n[e][t]=s[t]}else n[e]=s;return r[o]=n,this.ya.store(STORAGE_KEYS.q.Ia,r)}Pa(){const t=this.ya.lr(STORAGE_KEYS.q.Ia);this.ya.remove(STORAGE_KEYS.q.Ia);const e=[];for(let s in t)null!=t[s]&&e.push(t[s]);return e}Er(t){const e=this.ya.lr(STORAGE_KEYS.q.Ia);if(null!=e){const s=this.La(null),r=e[s];null!=r&&(e[s]=void 0,this.ya.store(STORAGE_KEYS.q.Ia,e),r[User.En]=t,this.Aa(r))}const s=this._r(STORAGE_KEYS.Cr.Dh);let r=null;null!=s&&(r=s.Ir);const o=this.Ba();if(null!=o)for(let e=0;e<o.length;e++){const s=o[e];null==s.userId&&s.sessionId==r&&(s.userId=t),this.Hh(s)}}xa(){return this.ya.Ja}}A._a=class{constructor(t){this.Vi=t,this.Ja=et.ka()?3:10}Va(t){return t+"."+this.Vi}store(t,e){const s={v:e};try{return localStorage.setItem(this.Va(t),JSON.stringify(s)),!0}catch(t){return r.D.info("Storage failure: "+t.message),!1}}lr(t){try{const e=JSON.parse(localStorage.getItem(this.Va(t)));return null==e?null:e.v}catch(t){return r.D.info("Storage retrieval failure: "+t.message),null}}remove(t){try{localStorage.removeItem(this.Va(t))}catch(t){return r.D.info("Storage removal failure: "+t.message),!1}}};A.ne=class{constructor(t,e){this.Vi=t,this.za=this.Qa(),this.Ha=576e3,this.Wa=!!e}Va(t){return null!=this.Vi?t+"."+this.Vi:t}Qa(){let t=0,e=document.location.hostname;const s=e.split("."),r="ab._gd";for(;t<s.length-1&&-1===document.cookie.indexOf(r+"="+r);)t++,e="."+s.slice(-1-t).join("."),document.cookie=r+"="+r+";domain="+e+";";return document.cookie=r+"=;expires="+new Date(0).toGMTString()+";domain="+e+";",e}ie(){const t=new Date;return t.setTime(t.getTime()+60*this.Ha*1e3),t.getFullYear()}Xa(){const t=At(STORAGE_KEYS.Cr),e=document.cookie.split(";");for(let s=0;s<e.length;s++){let r=e[s];for(;" "===r.charAt(0);)r=r.substring(1);let o=!1;for(let e=0;e<t.length;e++)if(0===r.indexOf(t[e])){o=!0;break}if(o){const t=r.split("=")[0];-1===t.indexOf("."+this.Vi)&&this.Za(t)}}}store(t,e){this.Xa();const s=new Date;s.setTime(s.getTime()+60*this.Ha*1e3);const o="expires="+s.toUTCString(),n="domain="+this.za;let i;i=this.Wa?e:encodeURIComponent(JSON.stringify(e));const a=this.Va(t)+"="+i+";"+o+";"+n+";path=/";return a.length>=4093?(r.D.info("Storage failure: string is "+a.length+" chars which is too large to store as a cookie."),!1):(document.cookie=a,!0)}lr(t){const e=[],s=this.Va(t)+"=",o=document.cookie.split(";");for(let n=0;n<o.length;n++){let i=o[n];for(;" "===i.charAt(0);)i=i.substring(1);if(0===i.indexOf(s))try{let t;t=this.Wa?i.substring(s.length,i.length):JSON.parse(decodeURIComponent(i.substring(s.length,i.length))),e.push(t)}catch(e){return r.D.info("Storage retrieval failure: "+e.message),this.remove(t),null}}return e.length>0?e[e.length-1]:null}remove(t){this.Za(this.Va(t))}Za(t){const e=t+"=;expires="+new Date(0).toGMTString();document.cookie=e,document.cookie=e+";path=/";const s=e+";domain="+this.za;document.cookie=s,document.cookie=s+";path=/"}};A.Oa=class{constructor(){this.$a={},this.tl=5242880,this.Ja=3}store(t,e){const s={value:e},o=this.sl(e);return o>this.tl?(r.D.info("Storage failure: object is â‰ˆ"+o+" bytes which is greater than the max of "+this.tl),!1):(this.$a[t]=s,!0)}sl(t){const e=[],s=[t];let r=0;for(;s.length;){const t=s.pop();if("boolean"==typeof t)r+=4;else if("string"==typeof t)r+=2*t.length;else if("number"==typeof t)r+=8;else if("object"==typeof t&&-1===e.indexOf(t)){e.push(t);for(let e in t)s.push(t[e])}}return r}lr(t){const e=this.$a[t];return null==e?null:e.value}remove(t){this.$a[t]=null}};A.wa=class{constructor(t,e,s){this.rl=[],e&&this.rl.push(new A.ne(t)),s&&this.rl.push(new A._a(t)),this.rl.push(new A.Oa(t))}store(t,e){let s=!0;for(let r=0;r<this.rl.length;r++)s=this.rl[r].store(t,e)&&s;return s}lr(t){for(let e=0;e<this.rl.length;e++){const s=this.rl[e].lr(t);if(null!=s)return s}return null}remove(t){for(let e=0;e<this.rl.length;e++)this.rl[e].remove(t)}};