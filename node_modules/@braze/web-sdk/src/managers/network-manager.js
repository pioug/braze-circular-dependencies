import Rt from"../models/backend-errors.js";import ue from"../models/braze-event.js";import{convertMsToSeconds as l,convertSecondsToMs as qt}from"../util/date-utils.js";import s from"../common/event-logger.js";import{isArray as p,isEqual as ii}from"../util/code-utils.js";import r from"../../shared-lib/braze-shared-lib.js";import{STORAGE_KEYS as o}from"./storage-manager.js";export default class wt{constructor(t,e,s,i,r,o,n,a,h,u,c){this.qi=t,this.h=e,this.Fo=s,this.v=i,this.j=r,this.wt=o,this.Vi=n,this.Bo=a,this.jo=h,this.Ko=u,this.sa=c,this.ia=["npm"]}As(t,e){const s=this.qi.te(),i=s.ri(),r=this.h.I(o.q.Yo);ii(r,i)||(t.device=i),t.api_key=this.Vi,t.time=l((new Date).valueOf(),!0);const n=this.h.I(o.q.oa)||[],a=this.h.I(o.q.ha)||"";if(this.ia.length>0&&(!ii(n,this.ia)||a!==this.j.ua())&&(t.sdk_metadata=this.ia),t.sdk_version=this.jo,this.Ko&&(t.sdk_flavor=this.Ko),t.app_version=this.sa,t.device_id=s.id,e){const e=this.v.getUserId();null!=e&&(t.user_id=e)}return t}$s(t,e,i){const o=e.auth_error,n=e.error;if(!o&&!n)return!0;if(o){let e;this.Fo.Yn();const s={errorCode:o.error_code};for(const t of i)p(t)&&"X-Braze-Auth-Signature"===t[0]&&(s.signature=t[1]);t.respond_with&&t.respond_with.user_id?s.userId=t.respond_with.user_id:t.user_id&&(s.userId=t.user_id);const n=o.reason;return n?(s.reason=n,e=`due to ${n}`):e=`with error code ${o.error_code}.`,this.Fo.Jn()||(e+=' Please use the "enableSdkAuthentication" initialization option to enable authentication.'),r.D.error(`SDK Authentication failed ${e}`),this.ca(t.events,t.attributes),this.Fo.Vn(s),!1}if(n){let i=n;switch(i){case Rt.la:const o="Received successful response with empty body.";return s.G(r.A.fa,{e:o}),r.D.info(o),!1;case Rt.ma:const n="Received successful response with invalid JSON";return s.G(r.A.fa,{e:n+": "+e.response}),r.D.info(n),!1;case Rt.pa:i=`The API key "${t.api_key}" is invalid for the baseUrl ${this.Bo}`;break;case Rt.ba:i="Sorry, we are not currently accepting your requests. If you think this is in error, please contact us.";break;case Rt.Ra:i="No device identifier. Please contact support@braze.com"}r.D.error("Backend error: "+i)}return!1}ga(t,e,s,i){return!!(t&&0!==t.length||e&&0!==e.length||s||i)}qa(t,e,s,i){const r=[],o=t=>t||"",n=o(this.v.getUserId());let a,h,u,c,l=this.ii(t,e);if(s.length>0){const t=[];for(const e of s){if(a=e.ri(),this.Fo.Jn()){if(n&&!a.user_id){c||(c={},c.events=[]),c.events.push(a);continue}if(o(a.user_id)!==n){h||(h=[]),h.push(a);continue}}t.push(a)}t.length>0&&(l.events=t)}if(i.length>0){const t=[];for(const e of i)this.Fo.Jn()&&o(e.user_id)!==n?(u||(u=[]),u.push(e)):t.push(e);t.length>0&&(l.attributes=t)}if(this.ca(h,u),l=this.As(l,!0),c){c=this.As(c,!1);const t={requestData:c,headers:this.qs(c)};r.push(t)}if(l&&!this.ga(l.events,l.attributes,t,e))return c?r:null;const f={requestData:l,headers:this.qs(l)};return r.push(f),r}ca(t,e){if(t){const e=[];for(const s of t){const t=ue.fromJson(s);t.time=qt(t.time),e.push(t)}this.h.bo(e)}if(e)for(const t of e)this.h.Aa(t)}Gs(t,e){let s="HTTP error ";null!=t&&(s+=t+" "),s+=e,r.D.error(s)}yr(t){return s.G(r.A.Da,{n:t})}ii(t,e,s){const i={};t&&(i.feed=!0),e&&(i.triggers=!0);const r=null!=s?s:this.v.getUserId();return r&&(i.user_id=r),i.config={config_time:this.wt.Os()},{respond_with:i}}qs(t,e){const s=[["X-Braze-Api-Key",this.Vi]];let i=!1;if(null!=t.respond_with&&t.respond_with.triggers&&(s.push(["X-Braze-TriggersRequest","true"]),i=!0),null!=t.respond_with&&t.respond_with.feed&&(s.push(["X-Braze-FeedRequest","true"]),i=!0),e&&(s.push(["X-Braze-ContentCardsRequest","true"]),i=!0),i&&s.push(["X-Braze-DataRequest","true"]),this.Fo.Jn()){const t=this.Fo.Kn();null!=t&&s.push(["X-Braze-Auth-Signature",t])}return s}Es(t,e){const s=t.device;s&&s.os_version instanceof Promise?s.os_version.then((s=>{t.device.os_version=s,e()})):e()}Bs(){this.Fo.Bs()}Ps(){return this.Bo}addSdkMetadata(t){for(const e of t)-1===this.ia.indexOf(e)&&this.ia.push(e)}}