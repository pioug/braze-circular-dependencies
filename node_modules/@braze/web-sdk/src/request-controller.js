import b from"./util/net.js";import ue from"./models/braze-event.js";import s from"./common/event-logger.js";import{randomInclusive as lt}from"./util/math.js";import t from"./models/request-result.js";import r from"../shared-lib/braze-shared-lib.js";import{STORAGE_KEYS as o}from"./managers/storage-manager.js";import u from"./managers/subscription-manager.js";export default class Tt{constructor(t,s,i,e,n,l,h,o,r,a){this.Vi=t,this.Bo=s,this.hl=0,this.ol=h.xa(),this.ul=null,this.j=i,this.qi=e,this.v=n,this.wt=l,this.h=h,this.Fo=r,this.jt=a,this.al=o,this.cl=new u,this.dl=50}ml(t,s){return!t&&!s&&this.Fo.Zn()>=this.dl}fl(t){let s=this.j.Eh();if(t.length>0){const i=this.v.getUserId();for(const e of t){const t=!e.userId&&!i||e.userId===i;e.type===r.A.Wh&&t&&(s=!0)}}return s}gl(t,s,i,e,n,l,h){null==i&&(i=!0),i&&this.bl();const u=this.h.Ba(),a=this.h.Pa();let c=!1;const d=(t,s)=>{let h=!1;b.Ms({url:this.Bo+"/data/",data:t,headers:s,S:i=>{null!=t.respond_with&&t.respond_with.triggers&&(this.hl=Math.max(this.hl-1,0)),this.jt.$s(t,i,s)?(this.Fo.Bs(),this.wt.lh(i),null!=t.respond_with&&t.respond_with.user_id!=this.v.getUserId()||(null!=t.device&&this.h.B(o.q.Yo,t.device),null!=t.sdk_metadata&&(this.h.B(o.q.oa,t.sdk_metadata),this.h.B(o.q.ha,this.j.ua())),this.al(i),"function"==typeof e&&e())):i.auth_error&&(h=!0)},error:()=>{null!=t.respond_with&&t.respond_with.triggers&&(this.hl=Math.max(this.hl-1,0)),this.jt.ca(t.events,t.attributes),"function"==typeof n&&n()},kl:t=>{if("function"==typeof l&&l(t),i&&!c){if(t&&!h)this.wl();else{let t=this.ul;(null==t||t<1e3*this.ol)&&(t=1e3*this.ol),this.wl(Math.min(3e5,lt(1e3*this.ol,3*t)))}c=!0}}})},m=this.fl(u),f=s||m;if(this.ml(h,m))return void r.D.info("Declining to flush data due to 50 consecutive authentication failures");if(i&&!this.jt.ga(u,a,t,f))return this.wl(),void("function"==typeof l&&l(!0));const g=this.jt.qa(t,f,u,a);f&&this.hl++;let p=!1;if(g)for(const t of g)this.jt.Es(t.requestData,(()=>d(t.requestData,t.headers))),p=!0;this.Fo.Jn()&&i&&!p?this.wl():m&&(r.D.info("Invoking new session subscriptions"),this.cl.St())}yl(){return this.hl>0}wl(t){this.vl||(null==t&&(t=1e3*this.ol),this.bl(),this.Sl=setTimeout((()=>{if(document.hidden){const t="visibilitychange",s=()=>{document.hidden||(document.removeEventListener(t,s,!1),this.gl())};document.addEventListener(t,s,!1)}else this.gl()}),t),this.ul=t)}bl(){null!=this.Sl&&(clearTimeout(this.Sl),this.Sl=null)}initialize(){this.vl=!1,this.wl()}destroy(){this.cl.removeAllSubscriptions(),this.Fo.Xn(),this.bl(),this.vl=!0,this.gl(null,null,!1),this.Sl=null}cr(t){return this.cl.ut(t)}openSession(){const t=this.j.ua()!==this.j.mo();t&&(this.h.Ua(o.Cr.Jo),this.h.Ua(o.Cr.Ur)),this.gl(null,!1,null,null,null),this.In(),t&&import("./Push/push-manager-factory.js").then((t=>{if(this.vl)return;const s=t.default.Xe();if(null!=s&&(s.isPushPermissionGranted()||s.isPushBlocked())){const t=()=>{s.dn()?r.D.info("Push token maintenance is disabled, not refreshing token for backend."):s.subscribe()},i=(s,i)=>{i&&t()},e=()=>{const s=this.h.I(o.q.xn);(null==s||s)&&t()},n=r.xt.Ft;new r.qt(n,r.D).hr(n.$t.Mr,i,e)}}))}changeUser(t,s,i){const e=this.v.getUserId();if(e!==t){this.j.kh(),null!=e&&this.gl(null,!1,null,null,null),this.v.Br(t),i?this.Fo.setSdkAuthenticationSignature(i):this.Fo.Qn();for(let t=0;t<s.length;t++)s[t].changeUser(null==e);null!=e&&this.h.Is(o.q.P),this.h.Is(o.q.Yo),this.openSession(),r.D.info('Changed user to "'+t+'".')}else{let s="Doing nothing.";i&&this.Fo.Kn()!==i&&(this.Fo.setSdkAuthenticationSignature(i),s="Updated SDK authentication signature"),r.D.info(`Current user is already ${t}. ${s}`)}}requestImmediateDataFlush(t){this.bl(),this.j.mo(),this.gl(null,null,null,null,null,t,!0)}requestFeedRefresh(){this.j.mo(),this.gl(!0)}zr(t,s){this.j.mo(),r.D.info("Requesting explicit trigger refresh."),this.gl(null,!0,null,t,s)}Nr(t,i){const e=r.A.jl,n={a:t,l:i},l=s.G(e,n);return l&&r.D.info(`Logged alias ${t} with label ${i}`),l}Or(i,e,n){if(this.wt.Gr(e))return r.D.info(`Custom Attribute "${e}" is blocklisted, ignoring.`),new t;const l={key:e,value:n},h=s.G(i,l);return h&&r.D.info(`Logged custom attribute: ${e} with value: ${n}`),h}setLastKnownLocation(t,i,e,n,l,h){const o={latitude:i,longitude:e};null!=n&&(o.altitude=n),null!=l&&(o.ll_accuracy=l),null!=h&&(o.alt_accuracy=h);const u=s.G(r.A.$l,o,t);return u&&r.D.info(`Set user last known location as ${JSON.stringify(o,null,2)}`),u}kr(t,s){const i=this.j.mo();return new ue(this.v.getUserId(),r.A.Al,t,i,{cid:s})}In(){const t=r.xt.Ft;new r.qt(t,r.D).setItem(t.$t.Cl,1,{baseUrl:this.Bo,data:{api_key:this.Vi,device_id:this.qi.te().id},userId:this.v.getUserId(),sdkAuthEnabled:this.Fo.Jn()})}wr(t){for(const s of t)if(s.api_key===this.Vi)this.jt.ca(s.events,s.attributes);else{const t=r.xt.Ft;new r.qt(t,r.D).setItem(t.$t.$r,r.it.nt(),s)}}Xr(i,e,n){if(this.wt.Gr(i))return r.D.info(`Custom Attribute "${i}" is blocklisted, ignoring.`),new t;let l,h;return null===e&&null===n?(l=r.A.Tl,h={key:i}):(l=r.A._l,h={key:i,latitude:e,longitude:n}),s.G(l,h)}Zr(t,i){const e={group_id:t,status:i};return s.G(r.A.ql,e)}}