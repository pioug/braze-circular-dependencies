import b from"../util/net.js";import C from"../common/base-provider.js";import e from"../managers/braze-instance.js";import ContentCards from"./content-cards.js";import{dateFromUnixTimestamp as h}from"../util/date-utils.js";import{isURIJavascriptOrData as j}from"../util/url-utils.js";import{newCardFromContentCardsJson as S,newCardFromSerializedValue as _}from"../Card/util/card-factory.js";import r from"../../shared-lib/braze-shared-lib.js";import{STORAGE_KEYS as o}from"../managers/storage-manager.js";import u from"../managers/subscription-manager.js";export default class v extends C{constructor(t,s,i,h,n){super(),this.v=t,this.h=s,this.wt=i,this.gt=h,this.jt=n,this.vt=new u,e.yt(this.vt),this.Ut=0,this.kt=0,this.zt();const o=r.xt.Ft;new r.qt(o,r.D).Jt(o.$t.Mt,(t=>{this.Bt(t)}))}Gt(){return this.Ht}Kt(t){this.Ht=t}Qt(){return this.Vt}Wt(t){this.Vt=t}zt(){const t=this.h.I(o.q.Xt)||[],s=[];for(let i=0;i<t.length;i++){const e=_(t[i]);null!=e&&s.push(e)}this.Yt=this.Zt(this.Cs(s,!1)),this.Ut=this.h.I(o.q.ws)||this.Ut,this.kt=this.h.I(o.q.Ss)||this.kt}vs(t,s,i,e){let h;if(s){h=[];for(const t of this.Yt)t.test&&h.push(t)}else h=this.Yt.slice();for(let i=0;i<t.length;i++){const e=t[i];let r=null;for(let t=0;t<this.Yt.length;t++)if(e.id===this.Yt[t].id){r=this.Yt[t];break}if(s){const t=S(e);null!=r&&r.viewed&&(t.viewed=!0),null!=t&&h.push(t)}else if(null==r){const t=S(e);null!=t&&h.push(t)}else{if(!r.ct(e))for(let t=0;t<h.length;t++)if(e.id===h[t].id){h.splice(t,1);break}}}this.Yt=this.Zt(this.Cs(h,s)),this._s(),this.Ut=i||0,this.h.B(o.q.ws,this.Ut),this.kt=e||0,this.h.B(o.q.Ss,this.kt)}ys(t){if(this.Us()&&null!=t&&t.cards){this.h.B(o.q.Ts,e.Ds());const s=t.full_sync;s||this.zt(),this.vs(t.cards,s,t.last_full_sync_at,t.last_card_updated_at),this.vt.St(this.Rs(!0))}}Bt(t){if(!this.Us())return;this.zt();const s=this.Yt.slice(),i=this.v.getUserId();for(let e=0;e<t.length;e++)if(i===t[e].userId||null==i&&null==t[e].userId){const i=t[e].card;let h=null;for(let t=0;t<this.Yt.length;t++)if(i.id===this.Yt[t].id){h=this.Yt[t];break}if(null==h){const t=S(i);null!=t&&s.push(t)}else{if(!h.ct(i))for(let t=0;t<s.length;t++)if(i.id===s[t].id){s.splice(t,1);break}}}this.Yt=this.Zt(this.Cs(s,!1)),this._s(),this.vt.St(this.Rs(!0))}Cs(t,s){const i=this.h.I(o.q.$)||{},e=this.h.I(o.q.O)||{},h=this.h.I(o.q.K)||{},r={},n={},a={};for(let s=0;s<t.length;s++)i[t[s].id]&&(t[s].clicked=!0,r[t[s].id]=!0),e[t[s].id]&&(t[s].viewed=!0,n[t[s].id]=!0),h[t[s].id]&&(t[s].dismissed=!0,a[t[s].id]=!0);return s&&(this.h.B(o.q.$,r),this.h.B(o.q.O,n),this.h.B(o.q.K,a)),t}Zt(t){const s=[],i=new Date,e=this.h.I(o.q.K)||{};let h=!1;for(let n=0;n<t.length;n++){const o=t[n].url;!this.gt&&o&&j(o)?r.D.error(`Card with url ${o} will not be displayed because Javascript URLs are disabled. Use the "allowUserSuppliedJavascript" option for braze.initialize to enable this card.`):(null==t[n].expiresAt||t[n].expiresAt>=i)&&!t[n].dismissed?s.push(t[n]):(e[t[n].id]=!0,h=!0)}return h&&this.h.B(o.q.K,e),s}_s(){const t=[];for(let s=0;s<this.Yt.length;s++)t.push(this.Yt[s].ss());this.h.B(o.q.Xt,t)}Fs(t,s){if(!this.Us())return void(this.Ls||(this.Ls=this.wt.Ns((()=>{this.Fs(t,s)}))));const i=this.jt.As({},!0);this.h.I(o.q.Ts)!==e.Ds()&&this.Js(),i.last_full_sync_at=this.Ut,i.last_card_updated_at=this.kt;const h=this.jt.qs(i,!0);this.jt.Es(i,(()=>{b.Ms({url:this.jt.Ps()+"/content_cards/sync",data:i,headers:h,S:e=>{this.jt.$s(i,e,h)?(this.jt.Bs(),this.ys(e),"function"==typeof t&&t()):"function"==typeof s&&s()},error:t=>{this.jt.Gs(t,"retrieving content cards"),"function"==typeof s&&s()}})}))}Rs(t){t||this.zt();const s=this.Zt(this.Yt);s.sort(((t,s)=>t.pinned&&!s.pinned?-1:s.pinned&&!t.pinned?1:t.updated>s.updated?-1:s.updated>t.updated?1:0));let i=Math.max(this.kt||0,this.Ut||0);return 0===i&&(i=void 0),this.h.I(o.q.Ss)===this.kt&&void 0===i&&(i=this.kt),new ContentCards(s,h(i))}Hs(t){return this.vt.ut(t)}Js(){this.Ut=0,this.kt=0,this.h.Is(o.q.ws),this.h.Is(o.q.Ss)}changeUser(t){t||(this.Yt=[],this.vt.St(new ContentCards(this.Yt.slice(),null)),this.h.Is(o.q.Xt),this.h.Is(o.q.$),this.h.Is(o.q.O),this.h.Is(o.q.K)),this.Js()}clearData(t){this.Ut=0,this.kt=0,this.Yt=[],this.vt.St(new ContentCards(this.Yt.slice(),null)),t&&(this.h.Is(o.q.Xt),this.h.Is(o.q.$),this.h.Is(o.q.O),this.h.Is(o.q.K),this.h.Is(o.q.ws),this.h.Is(o.q.Ss))}Us(){return!!this.wt.Ks()||(0!==this.wt.Os()&&this.Qs(),!1)}Qs(){this.vt.St(new ContentCards([],(new Date).valueOf())),this.h.Is(o.q.Xt)}}